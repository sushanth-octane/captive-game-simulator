<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Captive Lending Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ["Bebas Neue", "ui-sans-serif", "system-ui"],
            body: ["IBM Plex Sans", "ui-sans-serif", "system-ui"],
            mono: ["IBM Plex Mono", "ui-monospace", "SFMono-Regular"],
          },
          colors: {
            ink: "#0E1A24",
            surf: "#0F2D2E",
            sand: "#F6F1E8",
            ember: "#F15A29",
            brass: "#D4A017",
            moss: "#3A7D44",
            sky: "#7CD4E6",
          },
          boxShadow: {
            glow: "0 10px 40px rgba(241, 90, 41, 0.25)",
          },
          keyframes: {
            floatIn: {
              "0%": { transform: "translateY(18px)", opacity: "0" },
              "100%": { transform: "translateY(0)", opacity: "1" },
            },
            shimmer: {
              "0%": { backgroundPosition: "0% 50%" },
              "100%": { backgroundPosition: "100% 50%" },
            },
          },
          animation: {
            floatIn: "floatIn 800ms ease-out both",
            shimmer: "shimmer 5s ease-in-out infinite alternate",
          },
        },
      },
    };
  </script>
  <link
    href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      height: 100%;
      background: #0e1a24;
      color: #f6f1e8;
      font-family: "IBM Plex Sans", ui-sans-serif, system-ui;
      user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    #root {
      height: 100%;
    }

    ::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    canvas {
      display: block;
    }

    /* Custom Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none;
      background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #F15A29;
      cursor: pointer;
      margin-top: -6px;
      box-shadow: 0 0 10px rgba(241, 90, 41, 0.5);
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: rgba(246, 241, 232, 0.2);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    const baseAssumptions = {
      baseReserve: 0.02,
      baseYield: 0.04,
      dealerShare: 0.6,
      runoff: 0.3,
      baseApr: 12,
    };

    const strategyCards = [
      {
        id: "no-pay",
        name: "90-Day No Pay",
        description: "Deferred payment campaign",
        volume: 0.15,
        reserve: 0,
        yield: -0.02,
      },
      {
        id: "buydown",
        name: "Rate Buydown",
        description: "Lower interest rates",
        volume: 0.25,
        reserve: -0.2,
        yield: -0.15,
      },
      {
        id: "protection",
        name: "F&I Protection",
        description: "Warranty/GAP focus",
        volume: -0.05,
        reserve: 0.3,
        yield: 0.05,
      },
      {
        id: "dealer-reserve",
        name: "Dealer Reserve",
        description: "Hold rate and optimize reserve",
        volume: 0.1,
        reserve: 0.15,
        yield: 0.08,
      },
      {
        id: "lifecycle",
        name: "Lifecycle Marketing",
        description: "Service coupons + retention outreach",
        volume: 0.08,
        reserve: 0.05,
        yield: 0.02,
      },
      {
        id: "limited-promos",
        name: "Limited-Time Promos",
        description: "Seasonal campaigns (Simulated Spikes)",
        volume: 0.12,
        reserve: -0.05,
        yield: -0.01,
        isEvent: true,
      },
      {
        id: "prequal",
        name: "Prequal Integration",
        description: "Digital prequal funnel",
        volume: 0.1,
        reserve: 0.05,
        yield: 0.03,
      },
    ];

    const formatCurrency = (value, digits = 0) =>
      new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: digits,
      }).format(value);

    const formatCompact = (value) =>
      new Intl.NumberFormat("en-US", {
        notation: "compact",
        maximumFractionDigits: 1,
      }).format(value);

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    // --- Dynamic Timeline Simulation Engine ---
    const computeSimulation = ({ timeline }) => {
      // Timeline is an array of 10 objects (Year 1 to Year 10), 
      // each containing: { inputs: {...}, cards: [...] }

      let portfolio = 0;
      const monthlyData = [];

      for (let m = 1; m <= 120; m++) {
        const year = Math.ceil(m / 12);
        const monthOfYear = (m - 1) % 12;

        // --- 1. Get Configuration for this Year ---
        // We use year-1 because array is 0-indexed
        const config = timeline[year - 1];
        const { inputs, cards } = config;

        // --- 2. Calculate Strategy Multipliers for this Year ---
        const activeCards = strategyCards.filter((card) =>
          cards.includes(card.id)
        );
        const hasSeasonalPromos = cards.includes("limited-promos");

        let currentVolumeMult = 1 + activeCards.reduce((sum, card) => sum + card.volume, 0);
        let currentReserveMult = 1 + activeCards.reduce((sum, card) => sum + card.reserve, 0);
        let currentYieldMult = 1 + activeCards.reduce((sum, card) => sum + card.yield, 0);

        // --- 3. Apply Input Variables & Adjustments ---
        const {
          annualVolume, avgLoan, earningPerVehicle,
          apr, firstLook, fiIncentive
        } = inputs;

        // Price Elasticity
        const aprDelta = apr - baseAssumptions.baseApr;
        currentVolumeMult *= 1 - aprDelta * 0.03;
        currentYieldMult *= 1 + aprDelta * 0.04;

        // First Look Impact
        let runoff = baseAssumptions.runoff;
        if (firstLook) {
          currentVolumeMult *= 1.08;
          currentYieldMult *= 1.06;
          runoff -= 0.02;
        }

        // Incentives Impact
        const incentiveFactor = fiIncentive / 100;
        currentVolumeMult *= 1 + incentiveFactor * 0.6;
        currentReserveMult *= 1 + incentiveFactor;
        currentYieldMult *= 1 + incentiveFactor * 0.4;

        // Seasonality & Events
        if (hasSeasonalPromos && (monthOfYear === 5 || monthOfYear === 11)) {
          currentVolumeMult *= 1.4;
          currentYieldMult *= 0.9;
        }
        // Standard seasonality removed as requested

        // --- 4. Monthly Calculation ---
        const monthlyVolumeBase = annualVolume / 12;
        const adjustedVolume = monthlyVolumeBase * clamp(currentVolumeMult, 0.2, 3.0);
        const adjustedReserve = baseAssumptions.baseReserve * currentReserveMult;
        const adjustedYield = baseAssumptions.baseYield * currentYieldMult + (apr - baseAssumptions.baseApr) * 0.002;
        const adjustedRunoff = clamp(runoff, 0.15, 0.5);

        const originations = adjustedVolume * avgLoan;
        const runoffAmount = portfolio * (adjustedRunoff / 12);

        portfolio = portfolio - runoffAmount + originations;

        const reserveIncome = originations * adjustedReserve;
        const yieldIncome = portfolio * (adjustedYield / 12);
        const grossProfit = reserveIncome + yieldIncome;
        const dealerProfit = grossProfit * baseAssumptions.dealerShare;
        const incentiveCost = adjustedVolume * earningPerVehicle * incentiveFactor;
        const netDealerProfit = dealerProfit - incentiveCost;

        monthlyData.push({
          month: m,
          year,
          portfolio,
          netDealerProfit,
          originations,
          volume: adjustedVolume,
          apr: apr,
          penetration: currentVolumeMult,
          cumulativeProfit: (monthlyData[monthlyData.length - 1]?.cumulativeProfit || 0) + netDealerProfit
        });
      }

      // --- 5. Aggregates for Charts/KPIs ---
      const portfolioValues = [];
      const annualProfits = [];
      const annualIncentives = [];

      for (let y = 1; y <= 10; y++) {
        const yearData = monthlyData.filter(d => d.year === y);
        portfolioValues.push({ year: y, value: yearData[yearData.length - 1].portfolio });
        annualProfits.push({ year: y, value: yearData.reduce((s, d) => s + d.netDealerProfit, 0) });

        // Approximate incentive cost for annual aggregates
        const yearInputs = timeline[y - 1].inputs;
        annualIncentives.push({
          year: y,
          value: yearData.reduce((s, d) => s + (d.volume * yearInputs.earningPerVehicle * (yearInputs.fiIncentive / 100)), 0)
        });
      }

      // KPI Logic (Uses Year 10 or Averages)
      const lastYearInputs = timeline[9].inputs;
      const ppu = lastYearInputs.annualVolume > 0 ? (annualProfits[9].value / lastYearInputs.annualVolume) : 0;
      const normalizedPPU = clamp(ppu / 1500, 0, 1);
      const score = Math.round(normalizedPPU * 100);

      const monthlyReserve = monthlyData[monthlyData.length - 1].portfolio * 0.004; // Simple approx for dashboard KPI
      const monthlyDeals = monthlyData[monthlyData.length - 1].volume;
      const annualIncentiveCost = annualIncentives.reduce((sum, item) => sum + item.value, 0) / 10;
      const averageAdjustedVolume = monthlyData.reduce((s, d) => s + d.volume, 0) / 10;

      return {
        adjustedVolume: averageAdjustedVolume,
        portfolioValues,
        annualProfits,
        score,
        monthlyReserve,
        monthlyDeals,
        annualIncentiveCost,
        monthlyData
      };
    };

    // --- Chart Components ---

    const DualAxisLineChart = ({ data, focusYear }) => {
      if (!data || data.length === 0) return null;

      const maxApr = 20;
      const minApr = 0;
      const maxPen = 3.0;
      const minPen = 0;
      const width = 100;
      const height = 100;

      const generatePath = (key, min, max) => {
        return data.map((d, i) => {
          const x = (i / (data.length - 1)) * (width);
          const y = height - ((d[key] - min) / (max - min)) * height;
          return `${x},${y}`;
        }).join(" ");
      };

      const aprPath = generatePath('apr', minApr, maxApr);
      const penPath = generatePath('penetration', minPen, maxPen);

      const startX = ((focusYear - 1) * 12) / (data.length - 1) * width;

      return (
        <div className="relative w-full h-full pb-4">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
            <defs>
              <linearGradient id="gradPen" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stopColor="#7CD4E6" stopOpacity="0.4" />
                <stop offset="100%" stopColor="#7CD4E6" stopOpacity="0.0" />
              </linearGradient>
            </defs>

            {Array.from({ length: 11 }).map((_, i) => (
              <line key={i} x1={i * 10} y1="0" x2={i * 10} y2={height} stroke="rgba(255,255,255,0.05)" strokeWidth="0.5" />
            ))}

            <path d={`M0,${height} ${penPath} L${width},${height} Z`} fill="url(#gradPen)" />
            <polyline points={penPath} fill="none" stroke="#7CD4E6" strokeWidth="2" strokeLinecap="round" vectorEffect="non-scaling-stroke" />
            <polyline points={aprPath} fill="none" stroke="#F15A29" strokeWidth="2" strokeDasharray="4,2" strokeLinecap="round" vectorEffect="non-scaling-stroke" />

            {/* Editing Focus Marker */}
            <g>
              <line x1={startX} y1="0" x2={startX} y2={height} stroke="#F15A29" strokeWidth="1" strokeDasharray="1,1" opacity="0.5" />
              <circle cx={startX} cy={height} r="1.5" fill="#F15A29" />
            </g>
          </svg>

          <div className="absolute -top-2 left-2 text-[10px] text-ember font-bold tracking-widest bg-ink/80 px-1 rounded">APR %</div>
          <div className="absolute -top-2 right-2 text-[10px] text-sky font-bold tracking-widest bg-ink/80 px-1 rounded">VOL MULT</div>

          <div className="absolute top-4 left-0 text-[9px] text-ember/60 font-mono">20%</div>
          <div className="absolute bottom-6 left-0 text-[9px] text-ember/60 font-mono">0%</div>
          <div className="absolute top-4 right-0 text-[9px] text-sky/60 font-mono">3.0x</div>
          <div className="absolute bottom-6 right-0 text-[9px] text-sky/60 font-mono">0x</div>

          <div className="absolute bottom-0 left-0 w-full flex justify-between px-1 text-[10px] text-sand/40 font-mono pt-2 border-t border-white/5">
            <span>Yr 1</span>
            <span>Yr 5</span>
            <span>Yr 10</span>
          </div>
        </div>
      );
    };

    const StackedAreaChart = ({ baselineData, activeData }) => {
      if (!baselineData || !activeData) return null;

      const width = 100;
      const height = 100;

      const maxProfit = Math.max(
        activeData[activeData.length - 1].cumulativeProfit,
        baselineData[baselineData.length - 1].cumulativeProfit
      ) * 1.1;

      const formatAxisValue = (val) => {
        if (val >= 1000000) return `$${(val / 1000000).toFixed(1)}M`;
        if (val >= 1000) return `$${(val / 1000).toFixed(0)}k`;
        return val;
      }

      const generateArea = (dataArr) => {
        const line = dataArr.map((d, i) => {
          const x = (i / (dataArr.length - 1)) * width;
          const y = height - (d.cumulativeProfit / maxProfit) * height;
          return `${x},${y}`;
        }).join(" ");
        return `M0,${height} ${line} L${width},${height} Z`;
      };

      const baseArea = generateArea(baselineData);
      const activeArea = generateArea(activeData);

      return (
        <div className="relative w-full h-full pb-4">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
            <defs>
              <linearGradient id="gradDiff" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stopColor="#0F2D2E" stopOpacity="0.9" />
                <stop offset="100%" stopColor="#0F2D2E" stopOpacity="0.2" />
              </linearGradient>
            </defs>

            {Array.from({ length: 11 }).map((_, i) => (
              <line key={i} x1={i * 10} y1="0" x2={i * 10} y2={height} stroke="rgba(255,255,255,0.05)" strokeWidth="0.5" />
            ))}

            <path d={activeArea} fill="#7CD4E6" fillOpacity="0.1" />
            <path d={activeArea} fill="url(#gradDiff)" />
            <polyline points={activeArea.split(" L")[0].substring(1)} fill="none" stroke="#7CD4E6" strokeWidth="1.5" vectorEffect="non-scaling-stroke" />
            <path d={baseArea} fill="#333" fillOpacity="0.5" />
            <polyline points={baseArea.split(" L")[0].substring(1)} fill="none" stroke="#666" strokeWidth="1" strokeDasharray="2,2" vectorEffect="non-scaling-stroke" />

          </svg>
          <div className="absolute bottom-8 right-2 text-[10px] text-sky font-bold tracking-widest bg-ink/80 px-1 rounded">TOTAL WEALTH</div>
          <div className="absolute bottom-12 left-10 text-[10px] text-gray-400 font-bold tracking-widest -rotate-12 pointer-events-none opacity-60">BASELINE</div>
          <div className="absolute top-0 right-0 text-[9px] text-sky/60 font-mono">{formatAxisValue(maxProfit)}</div>
          <div className="absolute bottom-6 right-0 text-[9px] text-sky/60 font-mono">$0</div>

          <div className="absolute bottom-0 left-0 w-full flex justify-between px-1 text-[10px] text-sand/40 font-mono pt-2 border-t border-white/5">
            <span>Yr 1</span>
            <span>Yr 5</span>
            <span>Yr 10</span>
          </div>
        </div>
      );
    };

    const CashFlowTable = ({ data }) => {
      return (
        <div className="overflow-x-auto max-h-64 custom-scrollbar">
          <table className="w-full text-left text-sm">
            <thead className="sticky top-0 bg-[#0E1A24] z-10 text-xs uppercase tracking-wider text-sand/50 border-b border-white/10">
              <tr>
                <th className="py-2">Year</th>
                <th className="py-2 text-right">Net Profit</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {data.map((item) => (
                <tr key={item.year} className="group hover:bg-white/5 transition-colors">
                  <td className="py-2 font-mono text-sand/70">Year {item.year}</td>
                  <td className="py-2 text-right font-mono text-sand">
                    {formatCurrency(item.value)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    // --- UI Components ---

    const LineChart = ({ data }) => {
      const maxValue = Math.max(...data.map((d) => d.value), 1);
      const points = data
        .map((d, i) => {
          const x = (i / (data.length - 1)) * 100;
          const y = 100 - (d.value / maxValue) * 100;
          return `${x},${y}`;
        })
        .join(" ");

      return (
        <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
          <defs>
            <linearGradient id="lineGlow" x1="0" x2="1">
              <stop offset="0%" stopColor="#F15A29" stopOpacity="0.1" />
              <stop offset="100%" stopColor="#F15A29" stopOpacity="0.9" />
            </linearGradient>
          </defs>
          <polyline
            points={points}
            fill="none"
            stroke="url(#lineGlow)"
            strokeWidth="2.4"
            strokeLinejoin="round"
            strokeLinecap="round"
          />
        </svg>
      );
    };

    const SliderInput = ({ label, value, min, max, step, onChange }) => (
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <p className="text-sm uppercase tracking-[0.2em] text-sand/70">
            {label}
          </p>
          <p className="font-mono text-lg text-sand">{typeof value === 'number' && value % 1 !== 0 ? value.toFixed(2) : value}</p>
        </div>
        <input
          type="range"
          className="w-full accent-ember"
          min={min}
          max={max}
          step={step}
          value={value}
          onChange={(event) => onChange(Number(event.target.value))}
        />
      </div>
    );

    const ToggleCard = ({ card, active, onToggle }) => (
      <button
        type="button"
        onClick={() => onToggle(card.id)}
        className={`w-full text-left rounded-2xl border px-4 py-4 transition-all duration-300 ${active
          ? "border-ember bg-ember/20 shadow-glow"
          : "border-sand/10 bg-white/5 hover:border-sand/30"
          }`}
      >
        <div className="flex items-center justify-between">
          <div>
            <h4 className="font-display text-xl tracking-wide flex items-center gap-2">
              {card.name}
              {card.isEvent && active && <span className="flex h-2 w-2 rounded-full bg-sky animate-pulse"></span>}
            </h4>
            <p className="text-sm text-sand/70 mt-1">{card.description}</p>
          </div>
          <div className="text-right text-xs uppercase tracking-[0.2em] font-mono opacity-80">
            <div>Vol {card.volume > 0 ? "+" : ""}{Math.round(card.volume * 100)}%</div>
            <div>Res {card.reserve > 0 ? "+" : ""}{Math.round(card.reserve * 100)}%</div>
          </div>
        </div>
      </button>
    );

    const StepIndicator = ({ step, current }) => (
      <div className="flex items-center gap-3">
        <div
          className={`h-3 w-3 rounded-full transition-colors duration-500 ${current >= step ? "bg-ember shadow-[0_0_10px_rgba(241,90,41,0.5)]" : "bg-white/20"
            }`}
        />
        <span className={`text-xs uppercase tracking-[0.3em] transition-colors duration-500 ${current >= step ? "text-sand" : "text-sand/30"
          }`}>
          Step {step}
        </span>
      </div>
    );

    const Splash = ({ onStart }) => (
      <div className="h-full flex flex-col justify-between p-8 md:p-12 animate-floatIn">
        <header className="flex items-start justify-between">
          <div>
            <p className="uppercase tracking-[0.4em] text-sand/70 text-xs mb-4">
              Captive Lending Simulator
            </p>
            <h1 className="font-display text-5xl md:text-8xl text-sand leading-[0.9]">
              Turn Deals Into a<br /> <span className="text-ember">10-Year Asset.</span>
            </h1>
          </div>
          <div className="hidden md:block text-right text-xs uppercase tracking-[0.3em] text-sand/50">
            Offline Ready<br />10-Year View
          </div>
        </header>
        <div className="grid md:grid-cols-2 gap-12 items-center">
          <div className="space-y-8">
            <p className="text-xl text-sand/80 leading-relaxed font-light">
              Replace the spreadsheet with a tactile, high-impact simulation
              that shows how captive lending builds wealth over a decade.
            </p>
            <ul className="space-y-4 text-sand/70 text-sm tracking-wide uppercase">
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Instant portfolio growth forecast</li>
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Strategy deck to stress-test assumptions</li>
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Role-based insights for owners</li>
            </ul>
            <button
              className="group mt-6 inline-flex items-center justify-center rounded-full bg-ember px-10 py-5 text-lg font-bold tracking-wider text-white shadow-glow transition-all hover:-translate-y-1 hover:bg-orange-600 active:translate-y-0"
              onClick={onStart}
            >
              Start Simulation
              <span className="ml-2 group-hover:translate-x-1 transition-transform">→</span>
            </button>
          </div>
          <div className="relative hidden md:block">
            <div className="rounded-3xl bg-gradient-to-br from-ember/90 via-brass/60 to-sky/60 p-[1px]">
              <div className="rounded-[1.4rem] bg-ink/95 p-8 backdrop-blur-sm">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-2">
                  10-Year Portfolio Value
                </p>
                <p className="font-display text-6xl text-sand">
                  {formatCurrency(42000000, 0)}
                </p>
                <div className="mt-8 h-32 rounded-2xl bg-white/5 p-4 border border-white/5">
                  <LineChart
                    data={Array.from({ length: 10 }, (_, i) => ({
                      year: i + 1,
                      value: 1200000 * (i + 1) * 0.9,
                    }))}
                  />
                </div>
                <p className="mt-6 text-sm text-sand/70 font-mono">
                  Powered by dealer cash flow + interest margin.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );

    const LeadCapture = ({ data, onChange, onNext }) => (
      <div className="h-full flex flex-col justify-between p-6 md:p-12 animate-floatIn overflow-y-auto">
        <div className="flex items-start justify-between mb-8">
          <div>
            <p className="uppercase tracking-[0.3em] text-sand/60 text-xs mb-2">
              Step 2 — Qualification
            </p>
            <h2 className="font-display text-4xl md:text-5xl text-sand">
              Calibrate the Simulation
            </h2>
          </div>
          <div className="hidden md:block text-right text-xs uppercase tracking-[0.3em] text-sand/50">
            Avg input time<br />60 seconds
          </div>
        </div>
        <div className="grid lg:grid-cols-2 gap-12">
          <div className="space-y-6">
            <div className="grid sm:grid-cols-2 gap-x-6 gap-y-6">
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60 sm:col-span-2">
                Dealer Group Name
                <input
                  type="text"
                  placeholder="e.g. Prestige Automotive"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.dealerName}
                  onChange={(event) =>
                    onChange({ ...data, dealerName: event.target.value })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Location
                <input
                  type="text"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.location}
                  onChange={(event) =>
                    onChange({ ...data, location: event.target.value })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Stores
                <input
                  type="number"
                  min="1"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.stores}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      stores: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Annual Used Volume
                <input
                  type="number"
                  min="100"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.annualVolume}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      annualVolume: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Avg Loan Amount
                <input
                  type="number"
                  min="1000"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.avgLoan}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      avgLoan: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Avg Frontend Gross
                <input
                  type="number"
                  min="500"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.frontendGross}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      frontendGross: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Earnings per Vehicle
                <input
                  type="number"
                  min="200"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.earningPerVehicle}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      earningPerVehicle: Number(event.target.value),
                    })
                  }
                />
              </label>
            </div>
          </div>
          <div className="rounded-3xl border border-white/10 bg-gradient-to-br from-white/5 via-white/0 to-ember/10 p-8 h-fit">
            <p className="text-xs uppercase tracking-[0.3em] text-sand/60 border-b border-white/10 pb-4 mb-4">
              Your Program Snapshot
            </p>
            <div className="space-y-5">
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Program Name</span>
                <span className="font-semibold text-sand text-right">
                  {(data.dealerName || "Dealer Group") + " Financing"}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Total Annual Volume</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCompact(data.annualVolume)} units
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Total Originations</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.annualVolume * data.avgLoan, 0)}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Stores</span>
                <span className="font-semibold text-sand font-mono">
                  {data.stores}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Avg Frontend Gross</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.frontendGross, 0)}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Earnings per Vehicle</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.earningPerVehicle, 0)}
                </span>
              </div>
            </div>
            <button
              className="mt-8 w-full rounded-full bg-ember py-4 text-base font-bold tracking-wide text-white shadow-lg shadow-ember/20 hover:bg-orange-600 transition-colors"
              onClick={onNext}
            >
              Continue
            </button>
          </div>
        </div>
      </div>
    );

    const Dashboard = ({ timeline, onUpdateTimeline, initialLeadData }) => {
      const [focusYear, setFocusYear] = useState(1);

      // Determine what to display based on the selected year
      const activeConfig = timeline[focusYear - 1];
      const activeInputs = activeConfig.inputs;
      const activeCards = activeConfig.cards;

      // Handle Input Change: Updates current year AND all future years (Propagation)
      const handleInputChange = (key, value) => {
        const newTimeline = [...timeline];
        // Propagate change from focusYear to Year 10
        for (let i = focusYear - 1; i < 10; i++) {
          newTimeline[i] = {
            ...newTimeline[i],
            inputs: { ...newTimeline[i].inputs, [key]: value }
          };
        }
        onUpdateTimeline(newTimeline);
      };

      // Handle Card Toggle: Updates current year AND all future years
      const handleCardToggle = (cardId) => {
        const newTimeline = [...timeline];
        const isCurrentlyActive = activeCards.includes(cardId);

        for (let i = focusYear - 1; i < 10; i++) {
          let yearCards = [...newTimeline[i].cards];
          if (isCurrentlyActive) {
            // Removing card
            yearCards = yearCards.filter(c => c !== cardId);
          } else {
            // Adding card (if not already there)
            if (!yearCards.includes(cardId)) yearCards.push(cardId);
          }
          newTimeline[i] = { ...newTimeline[i], cards: yearCards };
        }
        onUpdateTimeline(newTimeline);
      };

      const simulation = useMemo(
        () => computeSimulation({ timeline }),
        [timeline]
      );

      // Baseline timeline: All years = initial inputs, no cards
      const baselineSimulation = useMemo(() => {
        const baseTimeline = Array(10).fill({ inputs: initialLeadData, cards: [] });
        return computeSimulation({ timeline: baseTimeline });
      }, [initialLeadData]);

      const portfolioNow = simulation.portfolioValues[9].value;
      const annualProfitNow = simulation.annualProfits[9].value;
      const annualDividend = annualProfitNow;
      const incentiveLift = annualProfitNow - baselineSimulation.annualProfits[9].value;

      return (
        <div className="h-full overflow-y-auto p-6 md:p-8 lg:p-12 space-y-8 animate-floatIn">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-2">
                Simulation Dashboard
              </p>
              <h2 className="font-display text-3xl md:text-5xl text-sand">
                {activeInputs.dealerName || "Your Dealer Group"}
              </h2>
            </div>
          </div>

          <div className="grid lg:grid-cols-[2fr_1fr] gap-8">
            {/* Left Column (Charts) */}
            <div className="space-y-8">
              {/* Main Growth Chart */}
              <div className="rounded-3xl border border-white/10 bg-white/5 p-8 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
                  <svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor" className="text-sand"><path d="M3 3v18h18v-2H5V3H3zm4 11h2v-4H7v4zm4 3h2V8h-2v9zm4-5h2V5h-2v7z" /></svg>
                </div>

                <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 relative z-10 mb-8">
                  <div>
                    <h3 className="font-display text-2xl text-sand">
                      Program Timeline
                    </h3>
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mt-1">
                      Editing Year {focusYear} (Changes propagate forward)
                    </p>
                  </div>

                  <div className="w-full md:w-64">
                    <SliderInput
                      label={`Editing Year: ${focusYear}`}
                      value={focusYear}
                      min={1}
                      max={10}
                      step={1}
                      onChange={setFocusYear}
                    />
                  </div>
                </div>

                <div className="grid gap-8">
                  {/* CHART 1: Strategy Metrics */}
                  <div className="h-48 w-full border-b border-white/5 pb-8">
                    <DualAxisLineChart data={simulation.monthlyData} focusYear={focusYear} />
                  </div>

                  {/* CHART 2: Wealth Stack */}
                  <div className="h-48 w-full">
                    <StackedAreaChart
                      baselineData={baselineSimulation.monthlyData}
                      activeData={simulation.monthlyData}
                    />
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-8">
                <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                    Strategy Deck (Year {focusYear}+)
                  </p>
                  <div className="space-y-3 h-80 overflow-y-auto pr-2 custom-scrollbar">
                    {strategyCards.map((card) => (
                      <ToggleCard
                        key={card.id}
                        card={card}
                        active={activeCards.includes(card.id)}
                        onToggle={handleCardToggle}
                      />
                    ))}
                  </div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-white/5 p-6 space-y-6">
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60">
                    Scenario Inputs (Year {focusYear}+)
                  </p>
                  <SliderInput
                    label="APR"
                    value={activeInputs.apr}
                    min={6}
                    max={20}
                    step={0.25}
                    onChange={(val) => handleInputChange("apr", val)}
                  />
                  <SliderInput
                    label="F&I Incentive %"
                    value={activeInputs.fiIncentive}
                    min={0}
                    max={30}
                    step={1}
                    onChange={(val) => handleInputChange("fiIncentive", val)}
                  />
                  <SliderInput
                    label="Avg Loan"
                    value={activeInputs.avgLoan}
                    min={5000}
                    max={45000}
                    step={500}
                    onChange={(val) => handleInputChange("avgLoan", val)}
                  />
                  <SliderInput
                    label="Annual Volume"
                    value={activeInputs.annualVolume}
                    min={100}
                    max={10000}
                    step={50}
                    onChange={(val) => handleInputChange("annualVolume", val)}
                  />
                </div>
              </div>

            </div>

            {/* Right Column (KPIs) */}
            <div className="space-y-4">
              {/* Role Focus Card */}
              <div className="rounded-3xl border border-ember/30 bg-gradient-to-br from-ember/20 via-white/5 to-white/0 p-6 shadow-glow">
                <div className="flex items-center gap-2 mb-4">
                  <div className="w-2 h-2 rounded-full bg-ember animate-pulse"></div>
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60">
                    Owner Focus
                  </p>
                </div>
                <p className="font-display text-4xl text-sand">
                  {formatCurrency(portfolioNow, 0)}
                </p>
                <p className="text-sm text-sand/70 mb-6">
                  10-year portfolio value
                </p>
                <div className="pt-6 border-t border-white/10">
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-1">
                    Annual Dividend
                  </p>
                  <p className="text-2xl font-mono font-semibold text-sand">
                    {formatCurrency(annualDividend, 0)}
                  </p>
                </div>
              </div>

              <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                  Cash Flow Distribution
                </p>
                <div className="mt-4">
                  <CashFlowTable data={simulation.annualProfits} />
                </div>
              </div>

              <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                  F&amp;I Incentive Impact
                </p>
                <div className="space-y-3 text-sm text-sand/70">
                  <div className="flex items-center justify-between border-b border-white/5 pb-2">
                    <span>Annual incentive cost</span>
                    <span className="font-mono text-sand">
                      {formatCurrency(simulation.annualIncentiveCost, 0)}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span>Net profit lift</span>
                    <span className="font-mono text-emerald-300 font-bold">
                      +{formatCurrency(incentiveLift, 0)}
                    </span>
                  </div>
                </div>
                <p className="mt-4 text-xs text-sand/50 italic">
                  *Incentives drive volume, offsetting the cost per vehicle.
                </p>
              </div>
            </div>
          </div>

          {/* Bottom Action Buttons */}
          <div className="flex justify-end gap-4 mt-8">
            <button
              className="rounded-full border border-white/20 bg-white/5 px-8 py-3 text-sm font-semibold tracking-wide text-sand hover:bg-white/10 transition-colors"
              onClick={() => window.location.reload()}
            >
              Start Over
            </button>
            <button
              className="rounded-full bg-ember px-8 py-3 text-sm font-bold tracking-wide text-white shadow-lg shadow-ember/20 hover:bg-orange-600 transition-colors"
              onClick={() => window.open('https://www.octane.co/contact', '_blank')}
            >
              I'm Interested - Sign Me Up with Octane
            </button>
          </div>
        </div>
      );
    };

    const App = () => {
      const [step, setStep] = useState(1);
      const [leadData, setLeadData] = useState({
        dealerName: "",
        location: "",
        email: "",
        annualVolume: 2400,
        avgLoan: 22000,
        stores: 3,
        frontendGross: 1800,
        earningPerVehicle: 900,
        apr: 12,
        firstLook: false,
        fiIncentive: 10,
      });

      // --- Timeline State: Array of 10 Years ---
      const [timeline, setTimeline] = useState(null);
      const [initialLeadData, setInitialLeadData] = useState(null);

      const containerStyles =
        "h-full w-full bg-[radial-gradient(circle_at_top,_rgba(124,212,230,0.12),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(241,90,41,0.2),_transparent_50%),linear-gradient(120deg,_#0E1A24,_#0F2D2E)]";

      const handleNextStep = () => {
        if (step === 2) {
          // Initialize timeline state when entering dashboard
          // Each year (1-10) starts with the data captured in Step 2 and NO cards
          const initTimeline = Array(10).fill(null).map(() => ({
            inputs: { ...leadData }, // Deep copy inputs
            cards: []                // Empty cards
          }));
          setTimeline(initTimeline);
          setInitialLeadData({ ...leadData });
        }
        setStep(step + 1);
      };

      return (
        <div className={`${containerStyles} h-full text-sand`}
          style={{ backgroundSize: "200% 200%" }}>
          <div className="absolute inset-0 opacity-30 bg-[linear-gradient(120deg,rgba(255,255,255,0.04)_0%,rgba(255,255,255,0)_55%)] pointer-events-none" />
          <div className="absolute inset-0 animate-shimmer pointer-events-none" />
          <div className="relative h-full flex flex-col">
            <div className="flex-none p-8 flex gap-4 z-20">
              {[1, 2, 3].map((stepIndex) => (
                <StepIndicator
                  key={stepIndex}
                  step={stepIndex}
                  current={step}
                />
              ))}
            </div>
            <div className="flex-1 overflow-hidden relative">
              {step === 1 && <Splash onStart={() => setStep(2)} />}
              {step === 2 && (
                <LeadCapture
                  data={leadData}
                  onChange={(data) => setLeadData(data)}
                  onNext={handleNextStep}
                />
              )}
              {step === 3 && timeline && (
                <Dashboard
                  timeline={timeline}
                  onUpdateTimeline={setTimeline}
                  initialLeadData={initialLeadData}
                />
              )}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>

</html>