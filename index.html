<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Captive Lending Simulator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ["Bebas Neue", "ui-sans-serif", "system-ui"],
            body: ["IBM Plex Sans", "ui-sans-serif", "system-ui"],
            mono: ["IBM Plex Mono", "ui-monospace", "SFMono-Regular"],
          },
          colors: {
            ink: "#0E1A24",
            surf: "#0F2D2E",
            sand: "#F6F1E8",
            ember: "#F15A29",
            brass: "#D4A017",
            moss: "#3A7D44",
            sky: "#7CD4E6",
          },
          boxShadow: {
            glow: "0 10px 40px rgba(241, 90, 41, 0.25)",
          },
          keyframes: {
            floatIn: {
              "0%": { transform: "translateY(18px)", opacity: "0" },
              "100%": { transform: "translateY(0)", opacity: "1" },
            },
            shimmer: {
              "0%": { backgroundPosition: "0% 50%" },
              "100%": { backgroundPosition: "100% 50%" },
            },
          },
          animation: {
            floatIn: "floatIn 800ms ease-out both",
            shimmer: "shimmer 5s ease-in-out infinite alternate",
          },
        },
      },
    };
  </script>
  <link
    href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Updated to latest Babel Standalone to support Optional Chaining (?.) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      height: 100%;
      background: #0e1a24;
      color: #f6f1e8;
      font-family: "IBM Plex Sans", ui-sans-serif, system-ui;
      user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    #root {
      height: 100%;
    }

    ::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    canvas {
      display: block;
    }

    /* Custom Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none;
      background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #F15A29;
      cursor: pointer;
      margin-top: -6px;
      box-shadow: 0 0 10px rgba(241, 90, 41, 0.5);
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: rgba(246, 241, 232, 0.2);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    const baseAssumptions = {
      baseReserve: 0.02,
      baseYield: 0.04,
      dealerShare: 0.6,
      runoff: 0.3,
      baseApr: 12,
    };

    const strategyCards = [
      {
        id: "no-pay",
        name: "90-Day No Pay",
        description: "Deferred payment campaign",
        volume: 0.15,
        reserve: 0,
        yield: -0.02,
      },
      {
        id: "buydown",
        name: "Rate Buydown",
        description: "Lower interest rates",
        volume: 0.25,
        reserve: -0.2,
        yield: -0.15,
      },
      {
        id: "protection",
        name: "F&I Protection",
        description: "Warranty/GAP focus",
        volume: -0.05,
        reserve: 0.3,
        yield: 0.05,
      },
      {
        id: "dealer-reserve",
        name: "Dealer Reserve",
        description: "Hold rate and optimize reserve",
        volume: 0.1,
        reserve: 0.15,
        yield: 0.08,
      },
      {
        id: "lifecycle",
        name: "Lifecycle Marketing",
        description: "Service coupons + retention outreach",
        volume: 0.08,
        reserve: 0.05,
        yield: 0.02,
      },
      {
        id: "limited-promos",
        name: "Limited-Time Promos",
        description: "Seasonal campaigns (Simulated Spikes)",
        volume: 0.12,
        reserve: -0.05,
        yield: -0.01,
        isEvent: true,
      },
      {
        id: "prequal",
        name: "Prequal Integration",
        description: "Digital prequal funnel",
        volume: 0.1,
        reserve: 0.05,
        yield: 0.03,
      },
    ];

    const formatCurrency = (value, digits = 0) =>
      new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: digits,
      }).format(value);

    const formatCompact = (value) =>
      new Intl.NumberFormat("en-US", {
        notation: "compact",
        maximumFractionDigits: 1,
      }).format(value);

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    const computeSimulation = ({
      annualVolume,
      avgLoan,
      stores,
      frontendGross,
      earningPerVehicle,
      apr,
      firstLook,
      fiIncentive,
      cards,
    }) => {
      // --- 1. Determine Multipliers ---
      const activeCards = strategyCards.filter((card) =>
        cards.includes(card.id)
      );

      let baseVolumeMult = 1 + activeCards.reduce((sum, card) => sum + card.volume, 0);
      let baseReserveMult = 1 + activeCards.reduce((sum, card) => sum + card.reserve, 0);
      let baseYieldMult = 1 + activeCards.reduce((sum, card) => sum + card.yield, 0);
      let runoff = baseAssumptions.runoff;

      const aprDelta = apr - baseAssumptions.baseApr;
      baseVolumeMult *= 1 - aprDelta * 0.03;
      baseYieldMult *= 1 + aprDelta * 0.04;

      if (firstLook) {
        baseVolumeMult *= 1.08;
        baseYieldMult *= 1.06;
        runoff -= 0.02;
      }

      const incentiveFactor = fiIncentive / 100;
      baseVolumeMult *= 1 + incentiveFactor * 0.6;
      baseReserveMult *= 1 + incentiveFactor;
      baseYieldMult *= 1 + incentiveFactor * 0.4;

      const adjustedRunoff = clamp(runoff, 0.15, 0.5);

      // --- 2. Run Monthly Simulation (120 Months) ---
      let portfolio = 0;
      const monthlyData = [];
      const monthlyVolumeBase = annualVolume / 12;
      const hasSeasonalPromos = cards.includes("limited-promos");

      for (let m = 1; m <= 120; m++) {
        const year = Math.ceil(m / 12);
        const monthOfYear = (m - 1) % 12;

        // Apply Seasonality / Events
        let monthlyVolumeMult = baseVolumeMult;
        let currentApr = apr;
        let currentYieldMult = baseYieldMult;

        // Simulating "Events" for the charts
        // If "Limited Promos" is on, we spike volume and drop APR every June & December
        if (hasSeasonalPromos && (monthOfYear === 5 || monthOfYear === 11)) {
          monthlyVolumeMult *= 1.4; // Spike volume
          currentApr -= 1.5;        // Drop APR
          currentYieldMult *= 0.9;  // Yield drops slightly due to promo rate
        } else {
          // Standard mild seasonality
          const seasonality = 1 + 0.08 * Math.sin((monthOfYear / 12) * Math.PI * 2);
          monthlyVolumeMult *= seasonality;
        }

        const adjustedVolume = monthlyVolumeBase * clamp(monthlyVolumeMult, 0.2, 3.0);
        const adjustedReserve = baseAssumptions.baseReserve * baseReserveMult;
        const adjustedYield = baseAssumptions.baseYield * currentYieldMult + (currentApr - baseAssumptions.baseApr) * 0.002;

        const originations = adjustedVolume * avgLoan;
        // Monthly runoff approx (annual runoff / 12)
        const runoffAmount = portfolio * (adjustedRunoff / 12);

        portfolio = portfolio - runoffAmount + originations;

        const reserveIncome = originations * adjustedReserve;
        const yieldIncome = portfolio * (adjustedYield / 12); // monthly yield
        const grossProfit = reserveIncome + yieldIncome;
        const dealerProfit = grossProfit * baseAssumptions.dealerShare;
        const incentiveCost = adjustedVolume * earningPerVehicle * incentiveFactor;
        const netDealerProfit = dealerProfit - incentiveCost;

        monthlyData.push({
          month: m,
          year,
          portfolio,
          netDealerProfit,
          originations,
          volume: adjustedVolume,
          apr: currentApr,
          penetration: monthlyVolumeMult, // Using multiplier as proxy for penetration
          cumulativeProfit: (monthlyData[monthlyData.length - 1]?.cumulativeProfit || 0) + netDealerProfit
        });
      }

      // --- 3. Aggregate Annual Data (for backwards compatibility) ---
      const portfolioValues = [];
      const annualProfits = [];
      const annualReserves = []; // We won't strictly use this but keep structure
      const annualIncentives = [];

      for (let y = 1; y <= 10; y++) {
        const yearData = monthlyData.filter(d => d.year === y);
        portfolioValues.push({ year: y, value: yearData[yearData.length - 1].portfolio });
        annualProfits.push({ year: y, value: yearData.reduce((s, d) => s + d.netDealerProfit, 0) });
        // simplified aggregates for other metrics
        annualIncentives.push({ year: y, value: yearData.reduce((s, d) => s + (d.volume * earningPerVehicle * incentiveFactor), 0) });
      }

      // --- 4. Score Calculation ---
      const ppu = annualVolume > 0 ? (annualProfits[9].value / annualVolume) : 0;
      const normalizedPPU = clamp(ppu / 1500, 0, 1);
      const score = Math.round(normalizedPPU * 100);

      const monthlyReserve = monthlyData[monthlyData.length - 1].portfolio * (baseAssumptions.baseYield * baseYieldMult / 12); // approx
      const monthlyDeals = monthlyData[monthlyData.length - 1].volume;

      const annualIncentiveCost = annualIncentives.reduce((sum, item) => sum + item.value, 0) / 10;
      const averageAdjustedVolume = monthlyData.reduce((s, d) => s + d.volume, 0) / 10; // annual avg

      return {
        adjustedVolume: averageAdjustedVolume,
        adjustedReserve: baseAssumptions.baseReserve * baseReserveMult,
        adjustedYield: baseAssumptions.baseYield * baseYieldMult,
        portfolioValues,
        annualProfits,
        score,
        monthlyReserve,
        monthlyDeals,
        monthlyProduction: monthlyData.slice(0, 12).map(d => ({ month: d.month, value: d.netDealerProfit })), // Just first year for mini chart
        annualIncentiveCost,
        monthlyData // NEW: Passing full resolution data
      };
    };

    // --- New Chart Components ---

    const DualAxisLineChart = ({ data }) => {
      // Data contains 120 months.
      // Left Axis: APR (data.apr) - usually 0 to 20
      // Right Axis: Penetration (data.penetration) - usually 0.5 to 2.5

      if (!data || data.length === 0) return null;

      const maxApr = 20;
      const minApr = 0;
      const maxPen = 2.5;
      const minPen = 0;

      const width = 100;
      const height = 100;
      const padding = 5;

      // Path Generators
      const generatePath = (key, min, max) => {
        return data.map((d, i) => {
          const x = (i / (data.length - 1)) * (width);
          const y = height - ((d[key] - min) / (max - min)) * height;
          return `${x},${y}`;
        }).join(" ");
      };

      const aprPath = generatePath('apr', minApr, maxApr);
      const penPath = generatePath('penetration', minPen, maxPen);

      return (
        <div className="relative w-full h-full">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
            <defs>
              <linearGradient id="gradPen" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stopColor="#7CD4E6" stopOpacity="0.4" />
                <stop offset="100%" stopColor="#7CD4E6" stopOpacity="0.0" />
              </linearGradient>
            </defs>

            {/* Grid Lines (Vertical Years) */}
            {Array.from({ length: 11 }).map((_, i) => (
              <line key={i} x1={i * 10} y1="0" x2={i * 10} y2={height} stroke="rgba(255,255,255,0.05)" strokeWidth="0.5" />
            ))}

            {/* Penetration Area Fill */}
            <path d={`M0,${height} ${penPath} L${width},${height} Z`} fill="url(#gradPen)" />
            {/* Penetration Line */}
            <polyline points={penPath} fill="none" stroke="#7CD4E6" strokeWidth="2" strokeLinecap="round" vectorEffect="non-scaling-stroke" />

            {/* APR Line */}
            <polyline points={aprPath} fill="none" stroke="#F15A29" strokeWidth="2" strokeDasharray="4,2" strokeLinecap="round" vectorEffect="non-scaling-stroke" />
          </svg>

          {/* Labels */}
          <div className="absolute top-2 left-2 text-[10px] text-ember font-bold tracking-widest bg-ink/80 px-1 rounded">APR % (Dash)</div>
          <div className="absolute top-2 right-2 text-[10px] text-sky font-bold tracking-widest bg-ink/80 px-1 rounded">VOL MULT (Solid)</div>
        </div>
      );
    };

    const StackedAreaChart = ({ baselineData, activeData }) => {
      // Compare cumulativeProfit
      if (!baselineData || !activeData) return null;

      const width = 100;
      const height = 100;

      const maxProfit = Math.max(
        activeData[activeData.length - 1].cumulativeProfit,
        baselineData[baselineData.length - 1].cumulativeProfit
      ) * 1.1; // +10% padding

      const generateArea = (dataArr) => {
        const line = dataArr.map((d, i) => {
          const x = (i / (dataArr.length - 1)) * width;
          const y = height - (d.cumulativeProfit / maxProfit) * height;
          return `${x},${y}`;
        }).join(" ");
        return `M0,${height} ${line} L${width},${height} Z`;
      };

      const baseArea = generateArea(baselineData);
      const activeArea = generateArea(activeData);

      return (
        <div className="relative w-full h-full">
          <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible" preserveAspectRatio="none">
            <defs>
              <linearGradient id="gradDiff" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stopColor="#0F2D2E" stopOpacity="0.9" />
                <stop offset="100%" stopColor="#0F2D2E" stopOpacity="0.2" />
              </linearGradient>
            </defs>

            {/* Grid Lines (Vertical Years) */}
            {Array.from({ length: 11 }).map((_, i) => (
              <line key={i} x1={i * 10} y1="0" x2={i * 10} y2={height} stroke="rgba(255,255,255,0.05)" strokeWidth="0.5" />
            ))}

            {/* Active (Top) Layer - Rendered first to be behind if needed, but here we want it to show the full volume. 
                        Actually, standard stacked logic: Render Total first, then Baseline on top?
                        Or Render Baseline, then Difference?
                        Prompt: "Layer 1: Baseline (Solid grey). Layer 2: Incremental (Gradient blue)."
                        This implies Baseline is at the bottom. Incremental is stacked ON TOP or is the difference?
                        Usually "Incremental Gain" means the delta. 
                        I will render the Active Area (Total) in Blue Gradient, and Baseline Area in Grey.
                        Since Active > Baseline usually, Active will be behind Baseline if I want Baseline to be visible solid grey.
                    */}

            {/* Total Wealth (Active) */}
            <path d={activeArea} fill="#7CD4E6" fillOpacity="0.1" />
            <path d={activeArea} fill="url(#gradDiff)" />
            <polyline points={activeArea.split(" L")[0].substring(1)} fill="none" stroke="#7CD4E6" strokeWidth="1.5" vectorEffect="non-scaling-stroke" />

            {/* Baseline Wealth */}
            <path d={baseArea} fill="#333" fillOpacity="0.5" />
            <polyline points={baseArea.split(" L")[0].substring(1)} fill="none" stroke="#666" strokeWidth="1" strokeDasharray="2,2" vectorEffect="non-scaling-stroke" />

          </svg>
          <div className="absolute bottom-2 right-2 text-[10px] text-sky font-bold tracking-widest bg-ink/80 px-1 rounded">TOTAL WEALTH</div>
          <div className="absolute bottom-8 left-10 text-[10px] text-gray-400 font-bold tracking-widest -rotate-12 pointer-events-none">BASELINE</div>
        </div>
      );
    };

    const LineChart = ({ data }) => {
      const maxValue = Math.max(...data.map((d) => d.value), 1);
      const points = data
        .map((d, i) => {
          const x = (i / (data.length - 1)) * 100;
          const y = 100 - (d.value / maxValue) * 100;
          return `${x},${y}`;
        })
        .join(" ");

      return (
        <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
          <defs>
            <linearGradient id="lineGlow" x1="0" x2="1">
              <stop offset="0%" stopColor="#F15A29" stopOpacity="0.1" />
              <stop offset="100%" stopColor="#F15A29" stopOpacity="0.9" />
            </linearGradient>
          </defs>
          <polyline
            points={points}
            fill="none"
            stroke="url(#lineGlow)"
            strokeWidth="2.4"
            strokeLinejoin="round"
            strokeLinecap="round"
          />
          {data.map((d, i) => {
            const x = (i / (data.length - 1)) * 100;
            const y = 100 - (d.value / maxValue) * 100;
            return (
              <circle
                key={d.year}
                cx={x}
                cy={y}
                r="2"
                fill="#7CD4E6"
                className="opacity-0 hover:opacity-100 transition-opacity duration-200"
              />
            );
          })}
        </svg>
      );
    };

    const BarChart = ({ data }) => {
      const maxValue = Math.max(...data.map((d) => d.value), 1);
      return (
        <div className="flex items-end gap-2 h-32">
          {data.map((d) => (
            <div
              key={d.year}
              className="flex-1 rounded-t bg-emerald-400/70 hover:bg-emerald-400 transition-colors"
              style={{ height: `${(d.value / maxValue) * 100}%` }}
              title={`Year ${d.year}: ${formatCurrency(d.value)}`}
            />
          ))}
        </div>
      );
    };

    const SliderInput = ({ label, value, min, max, step, onChange }) => (
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <p className="text-sm uppercase tracking-[0.2em] text-sand/70">
            {label}
          </p>
          <p className="font-mono text-lg text-sand">{typeof value === 'number' && value % 1 !== 0 ? value.toFixed(2) : value}</p>
        </div>
        <input
          type="range"
          className="w-full accent-ember"
          min={min}
          max={max}
          step={step}
          value={value}
          onChange={(event) => onChange(Number(event.target.value))}
        />
      </div>
    );

    const ToggleCard = ({ card, active, onToggle }) => (
      <button
        type="button"
        onClick={() => onToggle(card.id)}
        className={`w-full text-left rounded-2xl border px-4 py-4 transition-all duration-300 ${active
            ? "border-ember bg-ember/20 shadow-glow"
            : "border-sand/10 bg-white/5 hover:border-sand/30"
          }`}
      >
        <div className="flex items-center justify-between">
          <div>
            <h4 className="font-display text-xl tracking-wide flex items-center gap-2">
              {card.name}
              {card.isEvent && active && <span className="flex h-2 w-2 rounded-full bg-sky animate-pulse"></span>}
            </h4>
            <p className="text-sm text-sand/70 mt-1">{card.description}</p>
          </div>
          <div className="text-right text-xs uppercase tracking-[0.2em] font-mono opacity-80">
            <div>Vol {card.volume > 0 ? "+" : ""}{Math.round(card.volume * 100)}%</div>
            <div>Res {card.reserve > 0 ? "+" : ""}{Math.round(card.reserve * 100)}%</div>
            <div>Yld {card.yield > 0 ? "+" : ""}{Math.round(card.yield * 100)}%</div>
          </div>
        </div>
      </button>
    );

    const StepIndicator = ({ step, current }) => (
      <div className="flex items-center gap-3">
        <div
          className={`h-3 w-3 rounded-full transition-colors duration-500 ${current >= step ? "bg-ember shadow-[0_0_10px_rgba(241,90,41,0.5)]" : "bg-white/20"
            }`}
        />
        <span className={`text-xs uppercase tracking-[0.3em] transition-colors duration-500 ${current >= step ? "text-sand" : "text-sand/30"
          }`}>
          Step {step}
        </span>
      </div>
    );

    const Splash = ({ onStart }) => (
      <div className="h-full flex flex-col justify-between p-8 md:p-12 animate-floatIn">
        <header className="flex items-start justify-between">
          <div>
            <p className="uppercase tracking-[0.4em] text-sand/70 text-xs mb-4">
              Captive Lending Simulator
            </p>
            <h1 className="font-display text-5xl md:text-8xl text-sand leading-[0.9]">
              Turn Deals Into a<br /> <span className="text-ember">10-Year Asset.</span>
            </h1>
          </div>
          <div className="hidden md:block text-right text-xs uppercase tracking-[0.3em] text-sand/50">
            Offline Ready<br />10-Year View
          </div>
        </header>
        <div className="grid md:grid-cols-2 gap-12 items-center">
          <div className="space-y-8">
            <p className="text-xl text-sand/80 leading-relaxed font-light">
              Replace the spreadsheet with a tactile, high-impact simulation
              that shows how captive lending builds wealth over a decade.
            </p>
            <ul className="space-y-4 text-sand/70 text-sm tracking-wide uppercase">
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Instant portfolio growth forecast</li>
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Strategy deck to stress-test assumptions</li>
              <li className="flex items-center gap-3"><span className="w-1.5 h-1.5 bg-sky rounded-full"></span>Role-based insights for owners</li>
            </ul>
            <button
              className="group mt-6 inline-flex items-center justify-center rounded-full bg-ember px-10 py-5 text-lg font-bold tracking-wider text-white shadow-glow transition-all hover:-translate-y-1 hover:bg-orange-600 active:translate-y-0"
              onClick={onStart}
            >
              Start Simulation
              <span className="ml-2 group-hover:translate-x-1 transition-transform">→</span>
            </button>
          </div>
          <div className="relative hidden md:block">
            <div className="rounded-3xl bg-gradient-to-br from-ember/90 via-brass/60 to-sky/60 p-[1px]">
              <div className="rounded-[1.4rem] bg-ink/95 p-8 backdrop-blur-sm">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-2">
                  10-Year Portfolio Value
                </p>
                <p className="font-display text-6xl text-sand">
                  {formatCurrency(42000000, 0)}
                </p>
                <div className="mt-8 h-32 rounded-2xl bg-white/5 p-4 border border-white/5">
                  <LineChart
                    data={Array.from({ length: 10 }, (_, i) => ({
                      year: i + 1,
                      value: 1200000 * (i + 1) * 0.9,
                    }))}
                  />
                </div>
                <p className="mt-6 text-sm text-sand/70 font-mono">
                  Powered by dealer cash flow + interest margin.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    );

    const LeadCapture = ({ data, onChange, onNext }) => (
      <div className="h-full flex flex-col justify-between p-6 md:p-12 animate-floatIn overflow-y-auto">
        <div className="flex items-start justify-between mb-8">
          <div>
            <p className="uppercase tracking-[0.3em] text-sand/60 text-xs mb-2">
              Step 2 — Qualification
            </p>
            <h2 className="font-display text-4xl md:text-5xl text-sand">
              Calibrate the Simulation
            </h2>
          </div>
          <div className="hidden md:block text-right text-xs uppercase tracking-[0.3em] text-sand/50">
            Avg input time<br />60 seconds
          </div>
        </div>
        <div className="grid lg:grid-cols-2 gap-12">
          <div className="space-y-6">
            <div className="grid sm:grid-cols-2 gap-x-6 gap-y-6">
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60 sm:col-span-2">
                Dealer Group Name
                <input
                  type="text"
                  placeholder="e.g. Prestige Automotive"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.dealerName}
                  onChange={(event) =>
                    onChange({ ...data, dealerName: event.target.value })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Location
                <input
                  type="text"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.location}
                  onChange={(event) =>
                    onChange({ ...data, location: event.target.value })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Stores
                <input
                  type="number"
                  min="1"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.stores}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      stores: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Annual Used Volume
                <input
                  type="number"
                  min="100"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.annualVolume}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      annualVolume: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Avg Loan Amount
                <input
                  type="number"
                  min="1000"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.avgLoan}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      avgLoan: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Avg Frontend Gross
                <input
                  type="number"
                  min="500"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.frontendGross}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      frontendGross: Number(event.target.value),
                    })
                  }
                />
              </label>
              <label className="block text-xs uppercase tracking-[0.2em] text-sand/60">
                Earnings per Vehicle
                <input
                  type="number"
                  min="200"
                  className="mt-2 w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-lg text-sand focus:border-ember focus:outline-none focus:bg-white/10 transition-colors"
                  value={data.earningPerVehicle}
                  onChange={(event) =>
                    onChange({
                      ...data,
                      earningPerVehicle: Number(event.target.value),
                    })
                  }
                />
              </label>
            </div>
          </div>
          <div className="rounded-3xl border border-white/10 bg-gradient-to-br from-white/5 via-white/0 to-ember/10 p-8 h-fit">
            <p className="text-xs uppercase tracking-[0.3em] text-sand/60 border-b border-white/10 pb-4 mb-4">
              Your Program Snapshot
            </p>
            <div className="space-y-5">
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Program Name</span>
                <span className="font-semibold text-sand text-right">
                  {(data.dealerName || "Dealer Group") + " Financing"}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Total Annual Volume</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCompact(data.annualVolume)} units
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Total Originations</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.annualVolume * data.avgLoan, 0)}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Stores</span>
                <span className="font-semibold text-sand font-mono">
                  {data.stores}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Avg Frontend Gross</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.frontendGross, 0)}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sand/70">Earnings per Vehicle</span>
                <span className="font-semibold text-sand font-mono">
                  {formatCurrency(data.earningPerVehicle, 0)}
                </span>
              </div>
            </div>
            <button
              className="mt-8 w-full rounded-full bg-ember py-4 text-base font-bold tracking-wide text-white shadow-lg shadow-ember/20 hover:bg-orange-600 transition-colors"
              onClick={onNext}
            >
              Continue
            </button>
          </div>
        </div>
      </div>
    );

    const RoleSelect = ({ role, onSelect, onNext }) => (
      <div className="h-full flex flex-col justify-between p-8 md:p-12 animate-floatIn">
        <div className="flex items-start justify-between">
          <div>
            <p className="uppercase tracking-[0.3em] text-sand/60 text-xs mb-2">
              Step 3 — Perspective
            </p>
            <h2 className="font-display text-4xl md:text-5xl text-sand">
              Choose Your Role
            </h2>
          </div>
          <div className="text-right text-xs uppercase tracking-[0.3em] text-sand/50 hidden md:block">
            Metrics tuned to<br />your incentives
          </div>
        </div>
        <div className="grid md:grid-cols-2 gap-8 my-8">
          {[
            {
              id: "gm",
              title: "General Manager / Dealer Principal",
              subtitle: "Macro view for long-term equity",
              focus: "10-Year Portfolio Value + Annual Dividends",
            },
            {
              id: "fm",
              title: "Finance Manager",
              subtitle: "Operational view for monthly income",
              focus: "Monthly Reserve + Deals Funded",
            },
          ].map((option) => (
            <button
              key={option.id}
              className={`group relative rounded-3xl border p-8 text-left transition-all duration-300 ${role === option.id
                  ? "border-ember bg-ember/10 shadow-glow"
                  : "border-white/10 bg-white/5 hover:bg-white/10"
                }`}
              onClick={() => onSelect(option.id)}
            >
              <div className={`absolute top-6 right-6 w-6 h-6 rounded-full border border-white/20 flex items-center justify-center ${role === option.id ? "bg-ember border-ember" : ""}`}>
                {role === option.id && <div className="w-2 h-2 bg-white rounded-full"></div>}
              </div>
              <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-3">
                {option.subtitle}
              </p>
              <h3 className="font-display text-3xl text-sand mb-6">
                {option.title}
              </h3>
              <div className="inline-block rounded-lg bg-black/20 px-3 py-2">
                <p className="text-sm text-sand/80 font-mono">KPI: {option.focus}</p>
              </div>
            </button>
          ))}
        </div>
        <div className="flex justify-end">
          <button
            className="rounded-full bg-ember px-10 py-4 text-lg font-bold tracking-wide text-white shadow-lg hover:bg-orange-600 transition-colors"
            onClick={onNext}
          >
            Enter Dashboard
          </button>
        </div>
      </div>
    );

    const Dashboard = ({ leadData, role, cards, onToggleCard }) => {
      const simulation = useMemo(
        () => computeSimulation({ ...leadData, cards }),
        [leadData, cards]
      );
      const baselineSimulation = useMemo(
        () => computeSimulation({ ...leadData, fiIncentive: 0, cards: [] }),
        [leadData]
      );

      const portfolioNow = simulation.portfolioValues[9].value;
      const annualProfitNow = simulation.annualProfits[9].value;
      const annualDividend = annualProfitNow;
      const monthlyReserve = simulation.monthlyReserve;
      const monthlyDeals = simulation.monthlyDeals;
      const incentiveLift =
        annualProfitNow - baselineSimulation.annualProfits[9].value;
      const programName = (leadData.dealerName || "Your Dealer Group") + " Financing";

      return (
        <div className="h-full overflow-y-auto p-6 md:p-8 lg:p-12 space-y-8 animate-floatIn">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-2">
                Simulation Dashboard
              </p>
              <h2 className="font-display text-3xl md:text-5xl text-sand">
                {leadData.dealerName || "Your Dealer Group"}
              </h2>
            </div>
            <div className="self-start md:self-auto rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs uppercase tracking-[0.3em] text-sand/60">
              {role === "gm" ? "GM Mode" : "FM Mode"}
            </div>
          </div>

          <div className="grid lg:grid-cols-[2fr_1fr] gap-8">
            {/* Left Column (Charts) */}
            <div className="space-y-8">
              {/* Main Growth Chart */}
              <div className="rounded-3xl border border-white/10 bg-white/5 p-8 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-8 opacity-10 pointer-events-none">
                  <svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor" className="text-sand"><path d="M3 3v18h18v-2H5V3H3zm4 11h2v-4H7v4zm4 3h2V8h-2v9zm4-5h2V5h-2v7z" /></svg>
                </div>

                <div className="flex flex-col md:flex-row md:items-center justify-between gap-6 relative z-10 mb-8">
                  <div>
                    <h3 className="font-display text-2xl text-sand">
                      Program Dynamics
                    </h3>
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mt-1">
                      Impact of Strategy Over Time
                    </p>
                  </div>
                </div>

                <div className="grid gap-8">
                  {/* CHART 1: Strategy Metrics */}
                  <div className="h-48 w-full border-b border-white/5 pb-8">
                    <DualAxisLineChart data={simulation.monthlyData} />
                  </div>

                  {/* CHART 2: Wealth Stack */}
                  <div className="h-48 w-full">
                    <StackedAreaChart
                      baselineData={baselineSimulation.monthlyData}
                      activeData={simulation.monthlyData}
                    />
                  </div>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-8">
                <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                    Strategy Deck
                  </p>
                  <div className="space-y-3 h-80 overflow-y-auto pr-2 custom-scrollbar">
                    {strategyCards.map((card) => (
                      <ToggleCard
                        key={card.id}
                        card={card}
                        active={cards.includes(card.id)}
                        onToggle={onToggleCard}
                      />
                    ))}
                  </div>
                </div>
                <div className="rounded-3xl border border-white/10 bg-white/5 p-6 space-y-6">
                  <p className="text-xs uppercase tracking-[0.3em] text-sand/60">
                    Baseline Inputs
                  </p>
                  <SliderInput
                    label="Annual Volume"
                    value={leadData.annualVolume}
                    min={100}
                    max={10000}
                    step={50}
                    onChange={(value) =>
                      leadData.setLeadData({
                        ...leadData,
                        annualVolume: value,
                      })
                    }
                  />
                  <SliderInput
                    label="APR"
                    value={leadData.apr}
                    min={6}
                    max={20}
                    step={0.25}
                    onChange={(value) =>
                      leadData.setLeadData({ ...leadData, apr: value })
                    }
                  />
                  <SliderInput
                    label="Avg Loan"
                    value={leadData.avgLoan}
                    min={5000}
                    max={45000}
                    step={500}
                    onChange={(value) =>
                      leadData.setLeadData({ ...leadData, avgLoan: value })
                    }
                  />
                  <SliderInput
                    label="F&I Incentive %"
                    value={leadData.fiIncentive}
                    min={0}
                    max={30}
                    step={1}
                    onChange={(value) =>
                      leadData.setLeadData({
                        ...leadData,
                        fiIncentive: value,
                      })
                    }
                  />
                </div>
              </div>

            </div>

            {/* Right Column (KPIs) */}
            <div className="space-y-4">
              {/* Role Focus Card */}
              {role === "gm" ? (
                <div className="rounded-3xl border border-ember/30 bg-gradient-to-br from-ember/20 via-white/5 to-white/0 p-6 shadow-glow">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="w-2 h-2 rounded-full bg-ember animate-pulse"></div>
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60">
                      Owner Focus
                    </p>
                  </div>
                  <p className="font-display text-4xl text-sand">
                    {formatCurrency(portfolioNow, 0)}
                  </p>
                  <p className="text-sm text-sand/70 mb-6">
                    10-year portfolio value
                  </p>
                  <div className="pt-6 border-t border-white/10">
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-1">
                      Annual Dividend
                    </p>
                    <p className="text-2xl font-mono font-semibold text-sand">
                      {formatCurrency(annualDividend, 0)}
                    </p>
                  </div>
                </div>
              ) : (
                <div className="rounded-3xl border border-sky/30 bg-gradient-to-br from-sky/20 via-white/5 to-white/0 p-6">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="w-2 h-2 rounded-full bg-sky animate-pulse"></div>
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60">
                      Finance Manager Focus
                    </p>
                  </div>
                  <p className="font-display text-4xl text-sand">
                    {formatCurrency(monthlyReserve, 0)}
                  </p>
                  <p className="text-sm text-sand/70 mb-6">
                    Monthly reserve income
                  </p>
                  <div className="pt-6 border-t border-white/10">
                    <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-1">
                      Deals Funded
                    </p>
                    <p className="text-2xl font-mono font-semibold text-sand">
                      {monthlyDeals.toFixed(0)} / month
                    </p>
                  </div>
                </div>
              )}

              <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                  Cash Flow Distribution
                </p>
                <div className="mt-4">
                  <BarChart data={simulation.annualProfits} />
                </div>
                <div className="mt-4 text-xs text-sand/60 text-center">
                  Annual Net Dealer Profit (Years 1-10)
                </div>
              </div>

              <div className="rounded-3xl border border-white/10 bg-white/5 p-6">
                <p className="text-xs uppercase tracking-[0.3em] text-sand/60 mb-4">
                  F&amp;I Incentive Impact
                </p>
                <div className="space-y-3 text-sm text-sand/70">
                  <div className="flex items-center justify-between border-b border-white/5 pb-2">
                    <span>Annual incentive cost</span>
                    <span className="font-mono text-sand">
                      {formatCurrency(simulation.annualIncentiveCost, 0)}
                    </span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span>Net profit lift</span>
                    <span className="font-mono text-emerald-300 font-bold">
                      +{formatCurrency(incentiveLift, 0)}
                    </span>
                  </div>
                </div>
                <p className="mt-4 text-xs text-sand/50 italic">
                  *Incentives drive volume, offsetting the cost per vehicle.
                </p>
              </div>
            </div>
          </div>

          {/* Bottom Action Buttons */}
          <div className="flex justify-end gap-4 mt-8">
            <button
              className="rounded-full border border-white/20 bg-white/5 px-8 py-3 text-sm font-semibold tracking-wide text-sand hover:bg-white/10 transition-colors"
              onClick={() => window.location.reload()}
            >
              Start Over
            </button>
            <button
              className="rounded-full bg-ember px-8 py-3 text-sm font-bold tracking-wide text-white shadow-lg shadow-ember/20 hover:bg-orange-600 transition-colors"
              onClick={() => window.open('https://www.octane.co/contact', '_blank')}
            >
              I'm Interested - Sign Me Up with Octane
            </button>
          </div>
        </div>
      );
    };

    const App = () => {
      const [step, setStep] = useState(1);
      const [leadData, setLeadData] = useState({
        dealerName: "",
        location: "",
        email: "",
        annualVolume: 2400,
        avgLoan: 22000,
        stores: 3,
        frontendGross: 1800,
        earningPerVehicle: 900,
        apr: 12,
        firstLook: false,
        fiIncentive: 10,
      });
      const [role, setRole] = useState("gm");
      const [cards, setCards] = useState([]);

      const containerStyles =
        "h-full w-full bg-[radial-gradient(circle_at_top,_rgba(124,212,230,0.12),_transparent_55%),radial-gradient(circle_at_bottom,_rgba(241,90,41,0.2),_transparent_50%),linear-gradient(120deg,_#0E1A24,_#0F2D2E)]";

      const handleToggleCard = (id) => {
        setCards((prev) =>
          prev.includes(id) ? prev.filter((item) => item !== id) : [...prev, id]
        );
      };

      return (
        <div className={`${containerStyles} h-full text-sand`}
          style={{ backgroundSize: "200% 200%" }}>
          <div className="absolute inset-0 opacity-30 bg-[linear-gradient(120deg,rgba(255,255,255,0.04)_0%,rgba(255,255,255,0)_55%)] pointer-events-none" />
          <div className="absolute inset-0 animate-shimmer pointer-events-none" />
          <div className="relative h-full flex flex-col">
            <div className="flex-none p-8 flex gap-4 z-20">
              {[1, 2, 3, 4].map((stepIndex) => (
                <StepIndicator
                  key={stepIndex}
                  step={stepIndex}
                  current={step}
                />
              ))}
            </div>
            <div className="flex-1 overflow-hidden relative">
              {step === 1 && <Splash onStart={() => setStep(2)} />}
              {step === 2 && (
                <LeadCapture
                  data={leadData}
                  onChange={(data) => setLeadData(data)}
                  onNext={() => setStep(3)}
                />
              )}
              {step === 3 && (
                <RoleSelect
                  role={role}
                  onSelect={(value) => setRole(value)}
                  onNext={() => setStep(4)}
                />
              )}
              {step === 4 && (
                <Dashboard
                  leadData={{ ...leadData, setLeadData }}
                  role={role}
                  cards={cards}
                  onToggleCard={handleToggleCard}
                />
              )}
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>

</html>